#### 1. Процесс работы с партнерскими сервисами умного дома
- там, где уместно "умный домофон" и "умный шлагбаум" называются "сервисами умного дома";

1. в мобильном приложении PropDevelopment появляются функции для контроля за подпиской на "умный домофон", "умный шлагбаум". Моблильное приложение должно обеспечивать возможность подключения/отключения функций умного дома, а также какие-то функции, связанные с просмотром текущего состояния подписки. Таким образом, примерный список функций в приложении выглядит так:
   1. подключить "умный домофон";
   2. подключить "умный шлагбаум";
   3. отключить "умный домофон";
   4. отключить "умный шлагбаум";
   5. просмотреть текущее состояние подписки - подключена/отключена ли функция;
   6. открыть "умный домофон" по кнопке в приложении;
   7. открыть "умный шлагбаум" по кнопке в приложении;

2. процесс подключения "сервисов умного дома":
   1. пользователь, используя "mobile app" создает завяку на подключение "сервисов умного дома", предоставляя свои персональные данные (для "умного домофона" можно предоставить биометрию);
   2. tenant-core-app сохраняет в БД информацию о том, что пользователь подал заявку на подключение "сервиса умного дома";
   3. теперь у пользователя в приложении отображается информация о том, что его заявка имеет некоторый статус "в работе". В БД это заявка имеет статус типа "ready_for_request";
   4. tenant-core-app видит, что есть заявка в статусе "ready_for_request" и обновляет ее статус на "requested", также записывается время обновления заявки - для использования паттерна Retry.  Далее, tenant-core-app отправляет запрос на подключение клиента к "сервису умного дома" через MQ;
   5. когда от внешней интеграции приходит ответ о том, что сервис подключен, то tenant-core-app обновляет запись в БД, обновляя статус с "requested" на "complete";
   6. с этого момента, клиент может работать с сервисом умного дома;

3. процесс работы с "сервисами умного дома" через приложение:
- автоматическое распознавание лиц и номера автомобиля реализовано на стороне сервисов партнеров;
- в приложении есть возможность "открыть дверь домофона" или "открыть шлагбаум" в случае, если биометрия не сработала или клиент не предоставил биометрию;
   1. предположим, что клиент хочет открыть дверь домофона через приложение. Клиент нажимает кнопку "открыть дверь домофона";
   2. tenant-core-app получает запрос на открытие двери домофона. В tenant-core-app уже реализован web socket, поэтому устанавливается web socket соединение, через которое клиент получит ответ, когда дверь будет открыта;
   3. tenant-core-app сохраняет UUID запроса в smart-home-cache и отправляет в smart-home-mq сообщение с командой для открытия двери домофона;
   4. далее, на стороне внешней интеграции производится открытие двери домофона и приходит ответ на наш запрос;
   5. tenant-core-app считывает ответ из очереди, видит, что в smart-home-cache есть такой запрос и отправляет ответ клиенту через server push о том, что дверь открыта;
- работа со шлагбаумом производится аналогично;

#### 2. Список требований, которым должны удовлетворять внешние интеграции
1. требования к безопасности:
- между нашей системой и внешней системой должно быть шифрование трафика (*TLS*);
- внешняя система должна поддерживать протокол аутентификации и авторизации;
- наш сервер авторизации (keycloak) должен отслеживать и фиксировать события выдачи Access token, а также неудачные попытки получения Access token;
- RabbitMQ проверяет Access Token прежде чем предоставлять доступ к очереди внешней системе;

2. Протоколы аутентификации и авторизации:
- для аутентификации и авторизации используются протоколы OAuth2 + OpenID Connect;
- партнерские сервисы получают Access Token из нашего сервера авторизации (auth-service-2), для того, чтобы считывать/записывать данные в очередь;

3. взаимодействие между системами предприятия и внешней платформой:
- наш сервис складывает данные в соответствующую очередь внутри smart-home-mq;
- внешний сервис, чтобы подключиться к smart-home-mq запрашивает Access Token у нашего сервера авторизации (auth-service-2);
- внешний сервис, используя Access Token, подключается к smart-home-mq и вычитывает данные из очереди;
- когда внешний сервис заканчивает обработку данных на своей стороне, то он, используя Access Token, подключается к smart-home-mq и записывает в нее свои данные;
- в случае, если Access Token или невалиден, внешняя система запрашивает новый Access Token у auth-service-2;